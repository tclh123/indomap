<!DOCTYPE html>
<html>
<head>
    <title>IndoMap - indoor map with routing</title>

    <link rel="stylesheet" type="text/css" href="script/css/style.css" />

    <script type="text/javascript" src="script/threejs/build/three.js"></script>
    <script type="text/javascript" src="script/threejs/build/controls/TrackballControls.js"></script>
    <script type="text/javascript" src="script/jquery-1.7.2.js"></script>

    <!--INDO MAP-->

    <script type="text/javascript" src="script/indo.js"></script>

    <script type="text/javascript" src="script/math.js"></script>
    <script type="text/javascript" src="script/place.js"></script>

    <script type="text/javascript" src="script/data.js"></script>

    <script>

        var SCREEN_WIDTH = window.innerWidth,
                SCREEN_HEIGHT = window.innerHeight;

        var camera, controls, scene, renderer;

        $(document).ready(function() {
            init();
            animate();
        });

        function init() {
            var container = $("#container")[0];

            scene = new THREE.Scene();

//            camera = new THREE.PerspectiveCamera(75, SCREEN_WIDTH / SCREEN_HEIGHT, 1, 10000);
//            camera.position.z = 100;

            camera = new THREE.PerspectiveCamera( 50, SCREEN_WIDTH / SCREEN_HEIGHT, 1, 5000 );
            camera.position.set( 500, 250, 500 );
            camera.lookAt( scene.position );

            controls = new THREE.TrackballControls( camera );
            controls.rotateSpeed = 1.0;
            controls.zoomSpeed = 10;
            controls.panSpeed = 0.8;
            controls.noZoom = false;
            controls.noPan = false;
            controls.staticMoving = true;
            controls.dynamicDampingFactor = 0.3;
//            controls.keys = [ 65, 83, 68 ];
            controls.addEventListener( 'change', render );

            renderer = new THREE.CanvasRenderer();
            renderer.setSize(SCREEN_WIDTH, SCREEN_HEIGHT);
            container.appendChild(renderer.domElement);

            drawElements();

            // Events

            window.addEventListener( 'resize', onWindowResize, false );
        }

        function animate() {
            requestAnimationFrame(animate);
            render();
            controls.update();
        }
        function drawElements() {

            // grid

            var size = 500, step = 25;
            var geometry = new THREE.Geometry();
            var axis = new THREE.Geometry();

            for ( var i = - size; i <= size; i += step ) {

                if(i == 0) {
                    axis.vertices.push( new THREE.Vector3( -size, 0, i ) );
                    axis.vertices.push( new THREE.Vector3(  size, 0, i ) );

                    axis.vertices.push( new THREE.Vector3( i, 0, -size ) );
                    axis.vertices.push( new THREE.Vector3( i, 0,  size ) );
                } else {
                    geometry.vertices.push( new THREE.Vector3( -size, 0, i ) );
                    geometry.vertices.push( new THREE.Vector3(  size, 0, i ) );

                    geometry.vertices.push( new THREE.Vector3( i, 0, -size ) );
                    geometry.vertices.push( new THREE.Vector3( i, 0,  size ) );
                }
            }
            var line = new THREE.Line( geometry, new THREE.LineBasicMaterial( { color: 0x888888, opacity: 0.5 } ), THREE.LinePieces );
            scene.add( line );
            var line = new THREE.Line( axis, new THREE.LineBasicMaterial( { color: 0x000000, opacity: 0.5 } ), THREE.LinePieces );
            scene.add( line );

            // particles

            var PI2 = Math.PI * 2;
            var material = new THREE.ParticleCanvasMaterial( {

                color: 0x000000,
                program: function ( context ) {

                    context.beginPath();
                    context.arc( 0, 0, 1, 0, PI2, true );
                    context.closePath();
                    context.fill();

                }

            } );

            var geometry = new THREE.Geometry();
            var Data = new INDO.Data();
            var placeList = Data.getPlaces();
            var pathList = Data.getPaths();
            for(var i in pathList) {
                var t = pathList[i];

                var particle = new THREE.Particle( material );
                particle.position.x = placeList[t[0]].x;
                particle.position.y = placeList[t[0]].y;
                particle.position.z = placeList[t[0]].z;

                particle.position.multiplyScalar( 10 ); ///??

                scene.add( particle );
                geometry.vertices.push( particle.position );

                var particle = new THREE.Particle( material );
                particle.position.x = placeList[t[1]].x;
                particle.position.y = placeList[t[1]].y;
                particle.position.z = placeList[t[1]].z;

                particle.position.multiplyScalar( 10 ); ///??

                scene.add( particle );
                geometry.vertices.push( particle.position );
            }

            // lines

            var line = new THREE.Line( geometry, new THREE.LineBasicMaterial( { color: 0x000000, opacity: 0.5 } ), THREE.LinePieces );
            scene.add( line );
        }
        function render() {

//            renderer.autoClear = false;       // no use?????
//            renderer.clear();

            renderer.render( scene, camera );
        }

        // Events
        function onWindowResize() {

            camera.aspect = SCREEN_WIDTH / SCREEN_HEIGHT;
            camera.updateProjectionMatrix();

            renderer.setSize( SCREEN_WIDTH, SCREEN_HEIGHT );

            controls.handleResize();

            render();

        }
    </script>
</head>
<body>
    <div id="container"></div>
</body>
</html>